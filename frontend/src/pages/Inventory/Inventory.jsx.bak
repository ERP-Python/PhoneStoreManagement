import { useState, useEffect } from 'react'
import {
  Typography,
  Box,
  Paper,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  TablePagination,
  TextField,
  Button,
  IconButton,
  CircularProgress,
  Alert,
  InputAdornment,
  Chip,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Link
} from '@mui/material'
import {
  Search as SearchIcon,
  Refresh as RefreshIcon,
  Warning as WarningIcon,
  Close as CloseIcon,
  ChevronLeft as ChevronLeftIcon,
  ChevronRight as ChevronRightIcon
} from '@mui/icons-material'
import api from '../../api/axios'
import { inventoryStyles } from './Inventory.styles'

export default function Inventory() {
  const [inventory, setInventory] = useState([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState(null)
  const [page, setPage] = useState(0)
  const [rowsPerPage, setRowsPerPage] = useState(10)
  const [searchTerm, setSearchTerm] = useState('')
  const [totalCount, setTotalCount] = useState(0)
  const [lowStockCount, setLowStockCount] = useState(0)
  
  // Dialog state
  const [selectedProduct, setSelectedProduct] = useState(null)
  const [dialogOpen, setDialogOpen] = useState(false)
  const [currentImageIndex, setCurrentImageIndex] = useState(0)

  const fetchInventory = async () => {
    try {
      setLoading(true)
      setError(null)
      
      const params = {
        page: page + 1,
        page_size: rowsPerPage,
      }
      
      if (searchTerm) {
        params.search = searchTerm
      }
      
      // Use new by_product endpoint
      const response = await api.get('/inventory/by_product/', { params })
      
      const inventoryData = response.data.results || response.data
      setInventory(inventoryData)
      setTotalCount(response.data.count || inventoryData.length)
      
      // Count low stock items
      const lowStock = inventoryData.filter(item => 
        item.status?.value === 'low_stock' || item.status?.value === 'out_of_stock'
      ).length
      setLowStockCount(lowStock)
      
    } catch (err) {
      console.error('Error fetching inventory:', err)
      setError('Không thể tải dữ liệu tồn kho. Vui lòng thử lại.')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchInventory()
  }, [page, rowsPerPage])

  const handleSearch = () => {
    setPage(0)
    fetchInventory()
  }

  const handleSearchKeyPress = (e) => {
    if (e.key === 'Enter') {
      handleSearch()
    }
  }

  const handleChangePage = (event, newPage) => {
    setPage(newPage)
  }

  const handleChangeRowsPerPage = (event) => {
    setRowsPerPage(parseInt(event.target.value, 10))
    setPage(0)
  }

  const handleProductClick = (product) => {
    setSelectedProduct(product)
    setDialogOpen(true)
  }

  const handleCloseDialog = () => {
    setDialogOpen(false)
    setSelectedProduct(null)
    setCurrentImageIndex(0)
  }

  const handlePreviousImage = () => {
    const images = selectedProduct?.images || []
    setCurrentImageIndex((prev) => (prev === 0 ? images.length - 1 : prev - 1))
  }

  const handleNextImage = () => {
    const images = selectedProduct?.images || []
    setCurrentImageIndex((prev) => (prev === images.length - 1 ? 0 : prev + 1))
  }

  const formatCurrency = (value) => {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND',
      maximumFractionDigits: 0
    }).format(value)
  }

  if (loading && inventory.length === 0) {
    return (
      <Box sx={inventoryStyles.loadingContainer}>
        <CircularProgress />
      </Box>
    )
  }

  return (
    <Box>
      <Box sx={{ mb: 4, textAlign: 'center' }}>
        <Typography 
          variant="h5" 
          sx={{ 
            m: 0,
            fontSize: '1.25rem',
            fontWeight: 600,
            lineHeight: 1.4,
            fontFamily: '"Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
            color: '#1e293b' 
          }}
        >
          Quản lý Tồn kho
        </Typography>
        <Typography variant="body2" sx={{ color: '#64748b', mt: 0.5 }}>
          Theo dõi số lượng tồn kho và trạng thái sản phẩm
        </Typography>
      </Box>

      {error && (
        <Alert severity="error" sx={inventoryStyles.errorAlert} onClose={() => setError(null)}>
          {error}
        </Alert>
      )}

      <Paper elevation={0} sx={{ p: 2, mb: 3, display: 'flex', alignItems: 'center', gap: 2, borderRadius: 2, border: '1px solid #e2e8f0', flexWrap: 'wrap' }}>
        <TextField
          placeholder="Tìm kiếm theo tên sản phẩm, SKU..."
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          onKeyPress={handleSearchKeyPress}
          size="small"
          sx={{ 
            flex: 1,
            minWidth: '200px',
            '& .MuiOutlinedInput-root': {
              backgroundColor: '#f8f9fa',
              borderRadius: 1,
              '& fieldset': {
                borderColor: '#e2e8f0',
              },
              '&:hover fieldset': {
                borderColor: '#cbd5e1',
              },
              '&.Mui-focused fieldset': {
                borderColor: '#667eea',
              }
            }
          }}
          InputProps={{
            startAdornment: (
              <InputAdornment position="start">
                <SearchIcon sx={{ color: '#94a3b8' }} />
              </InputAdornment>
            ),
          }}
        />
        
        <Chip 
          icon={<WarningIcon />} 
          label={`${lowStockCount} sản phẩm sắp hết`}
          color="warning"
          variant="outlined"
          sx={{ borderRadius: 1, height: 40 }}
        />

        <Button
          variant="contained"
          onClick={handleSearch}
          sx={{ 
            backgroundColor: '#667eea',
            color: '#fff',
            height: 40,
            px: 3,
            borderRadius: 1,
            textTransform: 'none',
            boxShadow: 'none',
            '&:hover': {
              backgroundColor: '#5a67d8',
              boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
            }
          }}
        >
          Tìm
        </Button>

        <IconButton 
          onClick={fetchInventory} 
          sx={{ 
            border: '1px solid #e2e8f0',
            borderRadius: 1,
            color: '#64748b',
            height: 40,
            width: 40,
            '&:hover': {
              backgroundColor: '#f8f9fa',
              color: '#667eea',
              borderColor: '#667eea'
            }
          }}
        >
          <RefreshIcon />
        </IconButton>
      </Paper>

      <TableContainer component={Paper} elevation={0} sx={{ border: '1px solid #e2e8f0', borderRadius: 2, overflow: 'hidden' }}>
        <Table>
          <TableHead>
            <TableRow>
              <TableCell>SKU</TableCell>
              <TableCell>Tên sản phẩm</TableCell>
              <TableCell align="right">Tồn kho</TableCell>
              <TableCell align="right">Đã đặt</TableCell>
              <TableCell align="right">Có thể bán</TableCell>
              <TableCell>Trạng thái</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {loading ? (
              <TableRow>
                <TableCell colSpan={6} align="center">
                  <CircularProgress size={30} />
                </TableCell>
              </TableRow>
            ) : inventory.length === 0 ? (
              <TableRow>
                <TableCell colSpan={6} align="center">
                  <Typography variant="body2" color="text.secondary">
                    Không tìm thấy dữ liệu tồn kho
                  </Typography>
                </TableCell>
              </TableRow>
            ) : (
              inventory.map((item) => (
                <TableRow key={item.id} hover>
                  <TableCell>
                    <Typography variant="body2" fontWeight="medium">
                      {item.sku || '-'}
                    </Typography>
                  </TableCell>
                  <TableCell>
                    <Link
                      component="button"
                      variant="body2"
                      onClick={() => handleProductClick(item)}
                      sx={{ 
                        textAlign: 'left',
                        cursor: 'pointer',
                        textDecoration: 'none',
                        '&:hover': {
                          textDecoration: 'underline',
                          color: 'primary.dark'
                        }
                      }}
                    >
                      {item.name || '-'}
                    </Link>
                    <Typography variant="caption" display="block" color="text.secondary">
                      {item.brand_name || ''} • {item.variants_count} biến thể
                    </Typography>
                  </TableCell>
                  <TableCell align="right">
                    <Typography 
                      variant="body2"
                      fontWeight="bold"
                      color={item.total_on_hand === 0 ? 'error.main' : 'text.primary'}
                    >
                      {item.total_on_hand || 0}
                    </Typography>
                  </TableCell>
                  <TableCell align="right">
                    <Typography variant="body2" color="warning.main">
                      {item.total_reserved || 0}
                    </Typography>
                  </TableCell>
                  <TableCell align="right">
                    <Typography 
                      variant="body2" 
                      fontWeight="medium"
                      color="success.main"
                    >
                      {item.total_available || 0}
                    </Typography>
                  </TableCell>
                  <TableCell>
                    <Chip
                      label={item.status?.label || 'N/A'}
                      color={item.status?.color || 'default'}
                      size="small"
                    />
                  </TableCell>
                </TableRow>
              ))
            )}
          </TableBody>
        </Table>
        <TablePagination
          rowsPerPageOptions={[5, 10, 25, 50]}
          component="div"
          count={totalCount}
          rowsPerPage={rowsPerPage}
          page={page}
          onPageChange={handleChangePage}
          onRowsPerPageChange={handleChangeRowsPerPage}
          labelRowsPerPage="Số hàng mỗi trang:"
          labelDisplayedRows={({ from, to, count }) => `${from}-${to} trong ${count}`}
        />
      </TableContainer>

      {/* Product Detail Dialog */}
      <Dialog 
        open={dialogOpen} 
        onClose={handleCloseDialog}
        maxWidth="lg"
        fullWidth
        PaperProps={{
          sx: {
            borderRadius: 2,
            boxShadow: '0 10px 40px rgba(0,0,0,0.1)'
          }
        }}
      >
        {/* Dialog Header */}
        <Box sx={{
          p: 3,
          backgroundColor: '#f8f9fa',
          borderBottom: '1px solid #e2e8f0',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'flex-start'
        }}>
          <Box flex={1}>
            <Typography variant="h5" fontWeight={600} mb={0.5}>
              {selectedProduct?.name}
            </Typography>
            <Box display="flex" gap={2} alignItems="center">
              <Typography variant="body2" color="text.secondary">
                {selectedProduct?.brand_name}
              </Typography>
              <Box sx={{ width: 1, height: 1, backgroundColor: '#cbd5e1', borderRadius: '50%' }} />
              <Typography variant="body2" color="text.secondary">
                SKU: <span style={{ fontWeight: 600, color: '#1e293b' }}>{selectedProduct?.sku}</span>
              </Typography>
            </Box>
          </Box>
          <IconButton onClick={handleCloseDialog} sx={{ mt: -0.5, mr: -0.5 }}>
            <CloseIcon />
          </IconButton>
        </Box>

        {/* Dialog Content */}
        <Box sx={{ p: 3, maxHeight: 'calc(100vh - 200px)', overflowY: 'auto' }}>
          {/* Product Images Gallery */}
          {selectedProduct?.images && selectedProduct.images.length > 0 && (
            <Box sx={{ mb: 4 }}>
              <Box
                sx={{
                  position: 'relative',
                  width: '100%',
                  backgroundColor: '#f8f9fa',
                  borderRadius: 1.5,
                  border: '1px solid #e2e8f0',
                  aspectRatio: '1',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  overflow: 'hidden'
                }}
              >
                <img
                  src={selectedProduct.images[currentImageIndex]?.url}
                  alt={selectedProduct.images[currentImageIndex]?.alt}
                  style={{
                    width: '100%',
                    height: '100%',
                    objectFit: 'contain',
                    padding: '20px'
                  }}
                />
                
                {/* Image Navigation */}
                {selectedProduct.images.length > 1 && (
                  <>
                    <IconButton
                      onClick={handlePreviousImage}
                      sx={{
                        position: 'absolute',
                        left: 10,
                        top: '50%',
                        transform: 'translateY(-50%)',
                        backgroundColor: 'rgba(0,0,0,0.5)',
                        color: '#fff',
                        '&:hover': {
                          backgroundColor: 'rgba(0,0,0,0.7)'
                        }
                      }}
                    >
                      <ChevronLeftIcon />
                    </IconButton>
                    <IconButton
                      onClick={handleNextImage}
                      sx={{
                        position: 'absolute',
                        right: 10,
                        top: '50%',
                        transform: 'translateY(-50%)',
                        backgroundColor: 'rgba(0,0,0,0.5)',
                        color: '#fff',
                        '&:hover': {
                          backgroundColor: 'rgba(0,0,0,0.7)'
                        }
                      }}
                    >
                      <ChevronRightIcon />
                    </IconButton>

                    {/* Image Counter */}
                    <Box
                      sx={{
                        position: 'absolute',
                        bottom: 10,
                        right: 10,
                        backgroundColor: 'rgba(0,0,0,0.7)',
                        color: '#fff',
                        px: 2,
                        py: 1,
                        borderRadius: 1,
                        fontSize: '0.875rem',
                        fontWeight: 500
                      }}
                    >
                      {currentImageIndex + 1} / {selectedProduct.images.length}
                    </Box>
                  </>
                )}
              </Box>

              {/* Thumbnail Gallery */}
              {selectedProduct.images.length > 1 && (
                <Box sx={{ display: 'flex', gap: 1, mt: 2, overflowX: 'auto', pb: 1 }}>
                  {selectedProduct.images.map((image, index) => (
                    <Box
                      key={image.id || index}
                      onClick={() => setCurrentImageIndex(index)}
                      sx={{
                        width: 80,
                        height: 80,
                        minWidth: 80,
                        borderRadius: 1,
                        border: currentImageIndex === index ? '3px solid #667eea' : '1px solid #e2e8f0',
                        backgroundColor: '#f8f9fa',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        overflow: 'hidden',
                        transition: 'all 0.2s ease',
                        '&:hover': {
                          borderColor: '#667eea',
                          boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                        }
                      }}
                    >
                      <img
                        src={image.url}
                        alt={image.alt}
                        style={{
                          width: '100%',
                          height: '100%',
                          objectFit: 'contain',
                          padding: '4px'
                        }}
                      />
                    </Box>
                  ))}
                </Box>
              )}
            </Box>
          )}

          {/* Summary Stats */}
          <Box sx={{ 
            display: 'grid',
            gridTemplateColumns: { xs: '1fr', sm: 'repeat(4, 1fr)' },
            gap: 2,
            mb: 4
          }}>
            {/* Total Stock Card */}
            <Paper elevation={0} sx={{
              p: 2.5,
              backgroundColor: '#f0f4ff',
              border: '1px solid #e0e7ff',
              borderRadius: 1.5,
              textAlign: 'center'
            }}>
              <Typography variant="caption" color="text.secondary" display="block" sx={{ textTransform: 'uppercase', fontSize: '0.7rem', fontWeight: 600, mb: 1 }}>
                Tồn kho
              </Typography>
              <Typography variant="h4" fontWeight={700} sx={{ color: '#1e293b', mb: 0.5 }}>
                {selectedProduct?.total_on_hand || 0}
              </Typography>
              <Typography variant="caption" color="text.secondary">
                {selectedProduct?.variants_count || 0} biến thể
              </Typography>
            </Paper>

            {/* Reserved Card */}
            <Paper elevation={0} sx={{
              p: 2.5,
              backgroundColor: '#fff7ed',
              border: '1px solid #fed7aa',
              borderRadius: 1.5,
              textAlign: 'center'
            }}>
              <Typography variant="caption" color="text.secondary" display="block" sx={{ textTransform: 'uppercase', fontSize: '0.7rem', fontWeight: 600, mb: 1 }}>
                Đã đặt
              </Typography>
              <Typography variant="h4" fontWeight={700} sx={{ color: '#ea580c', mb: 0.5 }}>
                {selectedProduct?.total_reserved || 0}
              </Typography>
              <Typography variant="caption" color="text.secondary">
                Chờ xử lý
              </Typography>
            </Paper>

            {/* Available Card */}
            <Paper elevation={0} sx={{
              p: 2.5,
              backgroundColor: '#f0fdf4',
              border: '1px solid #bbf7d0',
              borderRadius: 1.5,
              textAlign: 'center'
            }}>
              <Typography variant="caption" color="text.secondary" display="block" sx={{ textTransform: 'uppercase', fontSize: '0.7rem', fontWeight: 600, mb: 1 }}>
                Có thể bán
              </Typography>
              <Typography variant="h4" fontWeight={700} sx={{ color: '#16a34a', mb: 0.5 }}>
                {selectedProduct?.total_available || 0}
              </Typography>
              <Typography variant="caption" color="text.secondary">
                Sẵn bán
              </Typography>
            </Paper>

            {/* Status Card */}
            <Paper elevation={0} sx={{
              p: 2.5,
              backgroundColor: selectedProduct?.status?.value === 'in_stock' ? '#f0fdf4' : selectedProduct?.status?.value === 'low_stock' ? '#fff7ed' : '#fee2e2',
              border: selectedProduct?.status?.value === 'in_stock' ? '1px solid #bbf7d0' : selectedProduct?.status?.value === 'low_stock' ? '1px solid #fed7aa' : '1px solid #fecaca',
              borderRadius: 1.5,
              textAlign: 'center',
              display: 'flex',
              flexDirection: 'column',
              justifyContent: 'center',
              alignItems: 'center'
            }}>
              <Chip
                label={selectedProduct?.status?.label || 'N/A'}
                color={selectedProduct?.status?.color || 'default'}
                sx={{ mb: 1, fontWeight: 600 }}
              />
              <Typography variant="caption" color="text.secondary">
                Trạng thái
              </Typography>
            </Paper>
          </Box>

          {/* Variants Section */}
          <Box>
            <Box sx={{ mb: 2, pb: 2, borderBottom: '1px solid #e2e8f0' }}>
              <Typography variant="h6" fontWeight={600}>
                Chi tiết biến thể
              </Typography>
              <Typography variant="body2" color="text.secondary">
                {selectedProduct?.variants_count || 0} biến thể • {selectedProduct?.variants?.length || 0} mục
              </Typography>
            </Box>

            {selectedProduct?.variants && selectedProduct.variants.length > 0 ? (
              <Box sx={{ display: 'grid', gridTemplateColumns: { xs: '1fr', md: 'repeat(2, 1fr)' }, gap: 2 }}>
                {selectedProduct.variants.map((variant) => (
                  <Paper 
                    key={variant.id} 
                    elevation={0}
                    sx={{
                      p: 2.5,
                      border: '1px solid #e2e8f0',
                      borderRadius: 1.5,
                      backgroundColor: '#fff',
                      transition: 'all 0.2s ease',
                      '&:hover': {
                        borderColor: '#cbd5e1',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.05)'
                      }
                    }}
                  >
                    {/* Variant Header */}
                    <Box sx={{ mb: 2, pb: 2, borderBottom: '1px solid #e2e8f0' }}>
                      <Box display="flex" justifyContent="space-between" alignItems="start">
                        <Box flex={1}>
                          <Typography variant="body2" fontWeight={600} sx={{ color: '#667eea' }}>
                            {variant.display || '-'}
                          </Typography>
                          <Typography variant="caption" color="text.secondary">
                            SKU: {variant.sku}
                          </Typography>
                        </Box>
                        <Typography variant="body2" fontWeight={600} sx={{ color: '#1e293b' }}>
                          {formatCurrency(variant.price)}
                        </Typography>
                      </Box>
                    </Box>

                    {/* Stock Stats Grid */}
                    <Box sx={{
                      display: 'grid',
                      gridTemplateColumns: 'repeat(3, 1fr)',
                      gap: 1.5
                    }}>
                      <Box>
                        <Typography variant="caption" color="text.secondary" display="block" sx={{ mb: 0.5 }}>
                          Tồn kho
                        </Typography>
                        <Typography 
                          variant="h6" 
                          fontWeight={700}
                          sx={{
                            color: variant.on_hand === 0 ? '#dc2626' : '#1e293b'
                          }}
                        >
                          {variant.on_hand}
                        </Typography>
                      </Box>
                      <Box>
                        <Typography variant="caption" color="text.secondary" display="block" sx={{ mb: 0.5 }}>
                          Đã đặt
                        </Typography>
                        <Typography variant="h6" fontWeight={700} sx={{ color: '#ea580c' }}>
                          {variant.reserved}
                        </Typography>
                      </Box>
                      <Box>
                        <Typography variant="caption" color="text.secondary" display="block" sx={{ mb: 0.5 }}>
                          Có thể bán
                        </Typography>
                        <Typography variant="h6" fontWeight={700} sx={{ color: '#16a34a' }}>
                          {variant.available}
                        </Typography>
                      </Box>
                    </Box>
                  </Paper>
                ))}
              </Box>
            ) : (
              <Typography variant="body2" color="text.secondary" align="center" sx={{ py: 3 }}>
                Không có dữ liệu biến thể
              </Typography>
            )}
          </Box>
        </Box>

        {/* Dialog Actions */}
        <Box sx={{
          p: 2,
          backgroundColor: '#f8f9fa',
          borderTop: '1px solid #e2e8f0',
          display: 'flex',
          justifyContent: 'flex-end',
          gap: 1
        }}>
          <Button 
            onClick={handleCloseDialog}
            variant="contained"
            sx={{
              backgroundColor: '#667eea',
              color: '#fff',
              textTransform: 'none',
              fontWeight: 500,
              px: 3,
              '&:hover': {
                backgroundColor: '#5a67d8'
              }
            }}
          >
            Đóng
          </Button>
        </Box>
      </Dialog>
    </Box>
  )
}
